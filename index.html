<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Draft Pad â€” Bookmarks & Save (Revised)</title>
<style>
  :root{
    --bg:#fafafa;
    --grid: rgba(0,0,0,0.05);
    --paper:#262626;
    --white:#fff;
    --muted:#6b6b6b;
  }
  html,body{height:100%;margin:0;background:var(--bg);font-family:Inter,system-ui,Arial;overflow:hidden}
  body{display:flex;flex-direction:column;align-items:center;user-select:none}

  /* GRID */
  body::before{
    content:"";position:fixed;inset:0;background-size:40px 40px;
    background-image:
      linear-gradient(to right, var(--grid) 1px, transparent 1px),
      linear-gradient(to bottom, var(--grid) 1px, transparent 1px);
    z-index:-1;
  }

  /* header */
  header{
    width:100%;max-width:980px;padding:14px 18px;box-sizing:border-box;display:flex;align-items:center;justify-content:space-between;
  }
  .iconBtn{
    width:44px;height:44px;border-radius:10px;background:#fff;display:flex;align-items:center;justify-content:center;font-size:22px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);cursor:pointer;position:relative;
  }

  /* nav label center */
  #nav{position:absolute;left:50%;transform:translateX(-50%);top:18px;color:var(--muted);font-weight:600}

  /* stage area */
  .stage{flex:1;width:100%;max-width:980px;display:flex;justify-content:center;align-items:center;padding:8px 12px;gap:18px;box-sizing:border-box}

  .sideBtn{width:44px;height:44px;border-radius:10px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center;font-size:20px;color:#333;cursor:pointer}

  #paperContainer{position:relative;width:320px;height:520px;max-width:88vw;max-height:86vh;display:flex;align-items:center;justify-content:center;transition:transform .22s ease}
  #paper{width:100%;height:100%;background:var(--paper);border-radius:10px;box-shadow: 0 18px 40px rgba(0,0,0,0.25);overflow:hidden;position:relative}

  canvas{display:block;width:100%;height:100%;touch-action:none}
  .corner{position:absolute;right:6px;top:6px;width:18px;height:18px;border-radius:50%;background: rgba(255,255,255,0.06);z-index:12;pointer-events:none}

  #textLayer{position:absolute;inset:0;color:var(--white);font-size:18px;line-height:1.3;padding:18px;box-sizing:border-box;outline:none;overflow:auto;white-space:pre-wrap;word-break:break-word}

  /* floating resize */
  #resizeFloating{position:absolute;width:34px;height:34px;border-radius:999px;background:#fff;color:#222;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 14px rgba(0,0,0,0.18);font-weight:700;cursor:grab;z-index:30}

  /* dropdowns */
  .dropdown{
    position:absolute;
    top:56px;
    min-width:240px;
    background:#fff;
    box-shadow:0 10px 30px rgba(0,0,0,0.12);
    border-radius:10px;
    padding:8px;
    display:none;
    z-index:80;
  }
  .dropdown.open{display:block}
  .bookmark-list{max-height:260px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}
  .bookmark-item{padding:10px;border-radius:8px;background:#f6f6f6;color:#222;cursor:pointer;display:flex;justify-content:space-between;align-items:center}
  .bookmark-item small{color:#666;margin-left:8px}

  .save-box{display:flex;gap:8px;align-items:center;padding:6px}
  .save-box input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
  .save-box button{padding:8px 10px;border-radius:8px;border:none;background:#222;color:#fff;cursor:pointer}

  .small{font-size:12px;color:#666;padding:6px}

  @media (max-width:480px){
    header{padding:10px}
    .iconBtn{width:40px;height:40px}
  }
</style>
</head>
<body>

<header>
  <div id="bookmarkBtn" class="iconBtn" title="Bookmarks" aria-haspopup="true" aria-expanded="false">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden>
      <path d="M6 2h12v18l-6-4-6 4V2z" stroke="#111" stroke-width="1.8" stroke-linejoin="round" stroke-linecap="round" fill="none"/>
    </svg>

    <div id="bookmarkDropdown" class="dropdown" style="left:0">
      <div style="padding:8px 10px;font-weight:700;">Bookmarked</div>
      <div style="height:1px;background:#e4e4e4;margin:6px 8px;border-radius:2px;"></div>
      <div class="bookmark-list" id="bookmarkList"></div>
      <div class="small">Tap item to open page</div>
    </div>
  </div>

  <div id="nav">Page 1</div>

  <div style="display:flex;gap:10px;align-items:center">
    <div id="saveBtn" class="iconBtn" title="Save page" aria-haspopup="true" aria-expanded="false">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden>
        <circle cx="12" cy="12" r="9" stroke="#111" stroke-width="1.6" fill="none"></circle>
        <path d="M12 8v8M8 12h8" stroke="#111" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>

      <div id="saveDropdown" class="dropdown" style="right:0;left:auto;">
        <div style="padding:8px 10px;font-weight:700">Save page</div>
        <div style="height:1px;background:#e4e4e4;margin:6px 8px;border-radius:2px;"></div>
        <div class="save-box">
          <input id="saveTitle" placeholder="Page title (optional)" />
          <button id="doSave">Save</button>
        </div>
        <div class="small">Saved titles appear in Bookmarks</div>
      </div>
    </div>
  </div>
</header>

<div class="stage">
  <div id="prevBtn" class="sideBtn" title="Previous" aria-label="Previous page">&#8592;</div>

  <div id="paperContainer">
    <div id="paper">
      <canvas id="canvas" aria-label="Drawing canvas"></canvas>
      <div class="corner"></div>
      <div id="textLayer" contenteditable="true" spellcheck="false" aria-label="Text layer"></div>
    </div>
    <div id="resizeFloating" title="Drag to resize">+</div>
  </div>

  <div id="nextBtn" class="sideBtn" title="Next" aria-label="Next page">&#8594;</div>
</div>

<script>
/* ---------- env / helpers ---------- */
const isMobile = (('ontouchstart' in window) && /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) || navigator.maxTouchPoints > 1;

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const paper = document.getElementById('paper');
const container = document.getElementById('paperContainer');
const textLayer = document.getElementById('textLayer');
const resizeHandle = document.getElementById('resizeFloating');
const navLabel = document.getElementById('nav');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

const bookmarkBtn = document.getElementById('bookmarkBtn');
const bookmarkDropdown = document.getElementById('bookmarkDropdown');
const bookmarkList = document.getElementById('bookmarkList');

const saveBtn = document.getElementById('saveBtn');
const saveDropdown = document.getElementById('saveDropdown');
const saveTitleInput = document.getElementById('saveTitle');
const doSaveBtn = document.getElementById('doSave');

/* page model: { img: ImageData|null, html: string, title: string|null } */
let pages = [];
let currentIndex = 0;

/* ---------- UTILS ---------- */
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------- canvas sizing ---------- */
function fitCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.max(1, Math.floor(rect.width * dpr));
  canvas.height = Math.max(1, Math.floor(rect.height * dpr));
  canvas.style.width = rect.width + 'px';
  canvas.style.height = rect.height + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
window.addEventListener('resize', ()=>{ fitCanvas(); positionFloatingHandle(); });
fitCanvas();

/* ---------- storage keys & init ---------- */
const STORAGE_KEY = 'draftpad_pages_v2_revised';

function initPages(){
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored){
    try{
      const parsed = JSON.parse(stored);
      if (Array.isArray(parsed) && parsed.length){
        pages = parsed.map(p => ({ img: null, html: p.html || '', title: p.title || null }));
      }
    }catch(e){ pages = []; }
  }
  if (pages.length === 0) pages = [{ img: null, html: '', title: null }];
  currentIndex = 0;
  loadPage(currentIndex);
  updateNav();
}
initPages();

/* ---------- drawing ---------- */
let drawing=false;
const brush = { size:3 };

function getPointerPos(e){
  const rect = canvas.getBoundingClientRect();
  if (e.touches && e.touches[0]) return { x: e.touches[0].clientX - rect.left, y: e.touches[0].clientY - rect.top };
  return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

function strokeStart(e){
  // if text is focused on desktop, avoid starting a stroke
  if (document.activeElement === textLayer && !isMobile) return;
  drawing = true;
  const p = getPointerPos(e);
  ctx.beginPath(); ctx.moveTo(p.x, p.y);
  e.preventDefault();
}
function strokeMove(e){
  if (!drawing) return;
  const p = getPointerPos(e);
  ctx.lineTo(p.x, p.y); ctx.lineWidth = brush.size; ctx.lineCap='round'; ctx.strokeStyle='#fff'; ctx.stroke();
  e.preventDefault();
}
function strokeEnd(e){ drawing=false; }

canvas.addEventListener('mousedown', strokeStart);
window.addEventListener('mousemove', strokeMove);
window.addEventListener('mouseup', strokeEnd);
canvas.addEventListener('touchstart', strokeStart, {passive:false});
canvas.addEventListener('touchmove', strokeMove, {passive:false});
canvas.addEventListener('touchend', strokeEnd);

/* ---------- text layer focus ---------- */
function focusTextIfDesktop(){
  if (!isMobile){
    setTimeout(()=> {
      textLayer.focus();
      const range = document.createRange(); range.selectNodeContents(textLayer); range.collapse(false);
      const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
    }, 60);
  } else {
    if (!textLayer.innerText.trim()){
      textLayer.innerText = 'Tap to type';
      textLayer.style.opacity = '0.7';
      textLayer.addEventListener('focus', ()=> textLayer.style.opacity='1', {once:true});
      textLayer.addEventListener('focus', ()=> { if (textLayer.innerText.trim()==='Tap to type') textLayer.innerText=''; }, {once:true});
    }
  }
}
focusTextIfDesktop();

/* ---------- save/load helpers ---------- */
function saveCurrentPage(){
  try{
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    pages[currentIndex].img = imgData;
  }catch(e){
    pages[currentIndex].img = null;
  }
  pages[currentIndex].html = textLayer.innerHTML;
  // persist minimal state (html + titles)
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(pages.map(p=>({ html: p.html||'', title: p.title||null }))));
  } catch(e){ console.warn('localStorage save failed', e); }
}

function loadPage(index){
  if (index < 0 || index >= pages.length) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const p = pages[index];
  textLayer.innerHTML = p.html || '';
  // restore image if available
  if (p.img){
    try{
      if (p.img.width === canvas.width && p.img.height === canvas.height){
        ctx.putImageData(p.img, 0, 0);
      } else {
        const tmp = document.createElement('canvas');
        tmp.width = p.img.width; tmp.height = p.img.height;
        tmp.getContext('2d').putImageData(p.img,0,0);
        ctx.drawImage(tmp, 0, 0, canvas.width, canvas.height);
      }
    }catch(e){ console.warn('restore image failed', e); }
  }
}

/* ---------- nav & animation ---------- */
function updateNav(){ navLabel.textContent = `Page ${currentIndex + 1}`; updateBookmarkList(); }

function animateSlide(dir, onComplete){
  const dist = dir * 120;
  container.style.transition = 'transform .26s ease';
  container.style.transform = `translateX(${dist}vw)`;
  setTimeout(()=> {
    container.style.transition = 'none';
    container.style.transform = `translateX(${-dist}vw)`;
    setTimeout(()=> {
      container.style.transition = 'transform .26s ease';
      container.style.transform = 'translateX(0)';
      setTimeout(()=> { container.style.transition = ''; if (onComplete) onComplete(); }, 260);
    }, 40);
  }, 260);
}

function goToNext(){
  saveCurrentPage();
  if (currentIndex < pages.length - 1){
    animateSlide(-1, ()=>{ currentIndex++; loadPage(currentIndex); updateNav(); if (!isMobile) textLayer.focus(); });
  } else {
    animateSlide(-1, ()=>{ pages.push({ img:null, html:'', title:null }); currentIndex = pages.length -1; loadPage(currentIndex); updateNav(); if (!isMobile) textLayer.focus(); });
  }
}
function goToPrev(){
  if (currentIndex === 0) return;
  saveCurrentPage();
  animateSlide(1, ()=>{ currentIndex--; loadPage(currentIndex); updateNav(); if (!isMobile) textLayer.focus(); });
}
prevBtn.addEventListener('click', goToPrev);
nextBtn.addEventListener('click', goToNext);

/* mobile swipe next/prev */
let touchStartX = 0;
document.addEventListener('touchstart', e => { if (e.touches && e.touches[0]) touchStartX = e.touches[0].clientX; }, {passive:true});
document.addEventListener('touchend', e => {
  const endX = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : 0;
  const diff = touchStartX - endX;
  if (Math.abs(diff) > 80){ if (diff > 0) goToNext(); else goToPrev(); }
});

/* ---------- floating handle positioning & resize ---------- */
function positionFloatingHandle(){
  const handle = resizeHandle;
  const rect = paper.getBoundingClientRect();
  const parentRect = container.getBoundingClientRect();
  const left = rect.right - parentRect.left - (handle.offsetWidth/2);
  const top = rect.top - parentRect.top - (handle.offsetHeight/2);
  handle.style.left = left + 'px';
  handle.style.top = top + 'px';
  handle.style.position = 'absolute';
}
positionFloatingHandle();

function beginResize(e){
  e.preventDefault();
  const p = e.touches ? e.touches[0] : e;
  const startX = p.clientX, startY = p.clientY;
  const cr = container.getBoundingClientRect();
  const startW = cr.width, startH = cr.height;
  function doResize(ev){
    const q = ev.touches ? ev.touches[0] : ev;
    const dx = q.clientX - startX, dy = q.clientY - startY;
    const newW = Math.max(160, startW + dx);
    const newH = Math.max(200, startH + dy);
    container.style.width = newW + 'px';
    container.style.height = newH + 'px';
    fitCanvas(); positionFloatingHandle();
    ev.preventDefault && ev.preventDefault();
  }
  function endResize(){ document.removeEventListener('mousemove', doResize); document.removeEventListener('mouseup', endResize); document.removeEventListener('touchmove', doResize); document.removeEventListener('touchend', endResize); saveCurrentPage(); }
  document.addEventListener('mousemove', doResize); document.addEventListener('mouseup', endResize);
  document.addEventListener('touchmove', doResize, {passive:false}); document.addEventListener('touchend', endResize);
}
resizeHandle.addEventListener('mousedown', beginResize);
resizeHandle.addEventListener('touchstart', beginResize, {passive:false});

/* ---------- bookmarks UI ---------- */
function updateBookmarkList(){
  bookmarkList.innerHTML = '';
  pages.forEach((p, idx) => {
    if (p.title){
      const item = document.createElement('div');
      item.className = 'bookmark-item';
      item.innerHTML = `<div><strong>${escapeHtml(p.title)}</strong><div style="font-size:12px;color:#666">Page ${idx+1}</div></div><div style="font-size:12px;color:#666">Open</div>`;
      item.addEventListener('click', ()=>{
        saveCurrentPage();
        currentIndex = idx;
        loadPage(currentIndex);
        updateNav();
        toggleDropdown(bookmarkDropdown, false);
        if (!isMobile) textLayer.focus();
      });
      bookmarkList.appendChild(item);
    }
  });
  if (!bookmarkList.children.length){
    const none = document.createElement('div'); none.style.padding='12px'; none.style.color='#666'; none.innerText='No bookmarks yet';
    bookmarkList.appendChild(none);
  }
}

/* ---------- DROPDOWN logic (fixed) ---------- */
/* toggleDropdown closes others and toggles target */
function toggleDropdown(el, forcedState){
  const want = typeof forcedState === 'boolean' ? forcedState : !el.classList.contains('open');
  // close all first
  [bookmarkDropdown, saveDropdown].forEach(d => d.classList.remove('open'));
  if (want) el.classList.add('open');
  // update aria-expanded on buttons
  bookmarkBtn.setAttribute('aria-expanded', bookmarkDropdown.classList.contains('open'));
  saveBtn.setAttribute('aria-expanded', saveDropdown.classList.contains('open'));
}

/* Prevent clicks inside dropdown from bubbling up to document click handler */
saveDropdown.addEventListener('click', e => e.stopPropagation());
bookmarkDropdown.addEventListener('click', e => e.stopPropagation());

/* click handlers to open dropdowns */
bookmarkBtn.addEventListener('click', (ev)=>{
  updateBookmarkList();
  toggleDropdown(bookmarkDropdown);
  bookmarkDropdown.style.left = '0px';
  bookmarkDropdown.style.right = 'auto';
  ev.stopPropagation();
});
saveBtn.addEventListener('click', (ev)=>{
  saveTitleInput.value = pages[currentIndex] && pages[currentIndex].title ? pages[currentIndex].title : '';
  toggleDropdown(saveDropdown);
  saveDropdown.style.right = '0px'; saveDropdown.style.left = 'auto';
  // focus input a tick later so it receives keyboard/focus
  setTimeout(()=> saveTitleInput.focus(), 40);
  ev.stopPropagation();
});

/* save action: save current page title */
doSaveBtn.addEventListener('click', (ev)=>{
  ev.stopPropagation();
  const title = saveTitleInput.value.trim();
  pages[currentIndex].title = title ? title : null;
  saveCurrentPage();
  updateBookmarkList();
  toggleDropdown(saveDropdown, false);
});

/* Also allow Enter key inside input to save */
saveTitleInput.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    doSaveBtn.click();
  }
});

/* click outside to close dropdowns (safe check using contains) */
document.addEventListener('click', (e)=>{
  // if click target is not inside bookmarkBtn or its dropdown, close it
  if (!bookmarkBtn.contains(e.target) && !bookmarkDropdown.contains(e.target)) bookmarkDropdown.classList.remove('open');
  if (!saveBtn.contains(e.target) && !saveDropdown.contains(e.target)) saveDropdown.classList.remove('open');
  // update aria states
  bookmarkBtn.setAttribute('aria-expanded', bookmarkDropdown.classList.contains('open'));
  saveBtn.setAttribute('aria-expanded', saveDropdown.classList.contains('open'));
});

/* ---------- persist minimal state on unload ---------- */
window.addEventListener('beforeunload', ()=> saveCurrentPage());

/* ---------- initial paint / restore ---------- */
fitCanvas();
loadPage(0);
updateNav();
setTimeout(positionFloatingHandle, 150);

</script>
</body>
</html>
